<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Juan Carlos Villaseñor-Derbez (JC)">

<title>EVR 628- Intro to Environmental Data Science</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="assig_2_files/libs/clipboard/clipboard.min.js"></script>
<script src="assig_2_files/libs/quarto-html/quarto.js" type="module"></script>
<script src="assig_2_files/libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="assig_2_files/libs/quarto-html/popper.min.js"></script>
<script src="assig_2_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="assig_2_files/libs/quarto-html/anchor.min.js"></script>
<link href="assig_2_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="assig_2_files/libs/quarto-html/quarto-syntax-highlighting-37eea08aefeeee20ff55810ff984fec1.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="assig_2_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="assig_2_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="assig_2_files/libs/bootstrap/bootstrap-81267100e462c21b3d6c0d5bf76a3417.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">


</head>

<body class="quarto-light">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#the-big-picture" id="toc-the-big-picture" class="nav-link active" data-scroll-target="#the-big-picture">The big picture</a></li>
  <li><a href="#this-assignment" id="toc-this-assignment" class="nav-link" data-scroll-target="#this-assignment">This assignment</a>
  <ul class="collapse">
  <li><a href="#grading-rubric" id="toc-grading-rubric" class="nav-link" data-scroll-target="#grading-rubric">Grading Rubric</a></li>
  </ul></li>
  <li><a href="#project-ideas-with-different-data-sets" id="toc-project-ideas-with-different-data-sets" class="nav-link" data-scroll-target="#project-ideas-with-different-data-sets">Project ideas with different data sets</a>
  <ul class="collapse">
  <li><a href="#tuna-data-from-the-wcpfc-or-iattc" id="toc-tuna-data-from-the-wcpfc-or-iattc" class="nav-link" data-scroll-target="#tuna-data-from-the-wcpfc-or-iattc">Tuna Data from the WCPFC or IATTC</a></li>
  <li><a href="#data-from-the-national-center-for-environmental-information-ncei" id="toc-data-from-the-national-center-for-environmental-information-ncei" class="nav-link" data-scroll-target="#data-from-the-national-center-for-environmental-information-ncei">Data from the National Center for Environmental Information NCEI</a></li>
  <li><a href="#strava-data" id="toc-strava-data" class="nav-link" data-scroll-target="#strava-data">STRAVA data</a></li>
  <li><a href="#dive-watch-data" id="toc-dive-watch-data" class="nav-link" data-scroll-target="#dive-watch-data">Dive watch data</a></li>
  <li><a href="#data-from-papers" id="toc-data-from-papers" class="nav-link" data-scroll-target="#data-from-papers">Data from papers</a></li>
  <li><a href="#synthetic-data" id="toc-synthetic-data" class="nav-link" data-scroll-target="#synthetic-data">Synthetic data</a></li>
  <li><a href="#other-data-sources" id="toc-other-data-sources" class="nav-link" data-scroll-target="#other-data-sources">Other data sources:</a></li>
  <li><a href="#none-of-these-are-working-for-you" id="toc-none-of-these-are-working-for-you" class="nav-link" data-scroll-target="#none-of-these-are-working-for-you">None of these are working for you?</a></li>
  </ul></li>
  </ul>
<div class="quarto-alternate-formats"><h2>Other Formats</h2><ul><li><a href="assig_2.pdf"><i class="bi bi-file-pdf"></i>PDF</a></li></ul></div></nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><a href="https://jcvdav.github.io/EVR_628/">EVR 628</a>- Intro to Environmental Data Science</h1>
<p class="subtitle lead">Assignment 2: Data wrangling</p>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Juan Carlos Villaseñor-Derbez (JC) </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<section id="the-big-picture" class="level1">
<h1>The big picture</h1>
<p>Remember that the final goal is to have a <code>portfolio</code> github repository where you can showcase your work. Assignment 1 was to create the repository, which should be mostly empty. Assignment two is to start adding R code to clean some data. The third assignment will be to visualize the data you have cleaned up here, so keep that in mind. Your final project will then culminate in an analyses that leverages the data and visualizations you’ll produce.</p>
</section>
<section id="this-assignment" class="level1">
<h1>This assignment</h1>
<p><strong>Task:</strong> Develop one data wrangling script that reads raw data (<em>e.g.</em> in <code>.xlsx</code> or <code>.csv</code>), performs data cleaning, transformation, or wrangling, and exports a processed version of the data (as an <code>.rds</code> file) to be used in later assignments.</p>
<p>This assignment will require quite a bit of work on three fronts: 1) coming up with an idea for a final project, 2) thinking about how you will get the wild data into a format that gets you closer to your final project, and 3) using lecture materials, live coding sessions, and function documentation to help you build your pipeline.</p>
<section id="grading-rubric" class="level2">
<h2 class="anchored" data-anchor-id="grading-rubric">Grading Rubric</h2>
<ul>
<li>50%: Your repository contains and R script called <code>data_processing_script.R</code> that:
<ul>
<li>5%: Clearly indicates packages loaded</li>
<li>5%: Uses relative paths to read / write data files</li>
<li>20%: Uses <a href="https://dplyr.tidyverse.org/reference/index.html"><code>dplyr()</code></a> verbs and <a href="https://tidyr.tidyverse.org/reference/index.html"><code>tidyr()</code></a> functions. Note that simply renaming columns or changing the order of columns is not enough. You must use at least 3 of the following<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>:
<ol type="1">
<li><code>filter()</code></li>
<li><code>mutate()</code></li>
<li><code>group_by()</code> and <code>summarize()</code></li>
<li><code>pivot_longer()</code> or <code>pivot_wider()</code></li>
<li>A type of <code>*_join()</code></li>
</ol></li>
<li>10%: The exported data conform to <code>tidy</code> data standards<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a>.</li>
<li>10%: Contains code documentation using comments <code>#</code>.</li>
</ul></li>
<li>25%: I can run your code and reproduce your clean data.</li>
<li>25%: README file:
<ul>
<li>10% Explains the main objective of your project. 2-3 sentences is enough.</li>
<li>15% Lists the column names of the clean data, and includes information on data type and a description of the column.</li>
</ul></li>
</ul>
<p>Some examples of repositories that would get a 100%:</p>
<ul>
<li><a href="https://github.com/jcvdav/portfolio">Analyzing mid-term survey data</a></li>
<li><a href="https://github.com/mex-fisheries/mex_ports">Building a geospatial dataset of Mexican ports</a>, by McGill undergraduate student Emma Zgonena</li>
</ul>
</section>
</section>
<section id="project-ideas-with-different-data-sets" class="level1">
<h1>Project ideas with different data sets</h1>
<p>Below are examples of data sources and final project ideas. For the purpose of this assignment you are not expected to provide an answer. You will simply prepare the data necessary to eventually provide the answer.</p>
<section id="tuna-data-from-the-wcpfc-or-iattc" class="level2">
<h2 class="anchored" data-anchor-id="tuna-data-from-the-wcpfc-or-iattc">Tuna Data from the <a href="https://www.wcpfc.int/data-catalogue">WCPFC</a> or <a href="https://www.iattc.org/en-US/Data/Public-domain">IATTC</a></h2>
<ul>
<li>Build a time series of catch-per-unit-effort for a species of your liking</li>
<li>Find the year in which total tuna catch peaked</li>
<li>Find the month where tuna catch is, on average, maximum</li>
</ul>
</section>
<section id="data-from-the-national-center-for-environmental-information-ncei" class="level2">
<h2 class="anchored" data-anchor-id="data-from-the-national-center-for-environmental-information-ncei">Data from the National Center for Environmental Information <a href="https://www.ncei.noaa.gov/">NCEI</a></h2>
</section>
<section id="strava-data" class="level2">
<h2 class="anchored" data-anchor-id="strava-data">STRAVA data<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a></h2>
<ul>
<li>Find your longest activity</li>
<li>Find your total traveled distance since you started logging activities</li>
<li>Find the average length of your runs</li>
<li>Analyze your trends in heart rate vs speed</li>
<li>Analyze the pace of runs performed with the Rosenstiel Running Club</li>
</ul>
</section>
<section id="dive-watch-data" class="level2">
<h2 class="anchored" data-anchor-id="dive-watch-data">Dive watch data<a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a></h2>
<ul>
<li>Calculate how much time you’ve spent underwater per week, month, or year</li>
<li>If you have air pressure info associated (or you keep a dive log with it), calculate your Surface Air Consumption Rate</li>
<li>What’s your longest dive?</li>
<li>What’s your deepest dive?</li>
<li>What is the average depth of all your dives?</li>
<li>What is the maximum number of dives you have done in a single day? a week?</li>
</ul>
</section>
<section id="data-from-papers" class="level2">
<h2 class="anchored" data-anchor-id="data-from-papers">Data from papers</h2>
<p>The following papers have data available. You could download their data and recreate or augment their figures.</p>
<ul>
<li>Jouffray et al., 2025. <a href="https://www.nature.com/articles/s41893-025-01631-8">Identifying and closing gaps in corporate reporting of ocean impacts</a></li>
<li>Clark et al., 2023 <a href="https://www.nature.com/articles/s41467-023-38900-z">Global assessment of marine plastic exposure risk for oceanic birds</a> | <a href="https://github.com/BirdLifeInternational/petrels-plastics">GitHub repo</a></li>
<li>Burguess et al, 2018. <a href="https://www.science.org/doi/10.1126/science.aao4248">Protecting marine mammals, turtles, and birds by rebuilding global fisheries</a> | <a href="https://github.com/grantmcdermott/bycatch">GitHub repo</a></li>
<li><a href="https://www.nature.com/articles/s41597-023-02824-6">A database of mapped global fishing activity 1950–2017</a></li>
<li>Kuczenski et al.&nbsp;2021<a href="https://onlinelibrary.wiley.com/doi/full/10.1111/faf.12596">Plastic gear loss estimates from remote observation of industrial fishing activity</a> | <a href="https://github.com/bkuczenski/scoping-gear-losses">GitHub repo</a></li>
<li>Oyanedel et al., 2025. <a href="https://www.nature.com/articles/s44183-025-00134-5">Improving detectability of illegal fishing activities across supply chains</a> | <a href="https://github.com/rodgpt/Detectability-of-illegal-activities">GitHub repo</a></li>
<li>O’Connor et al., 2024 <a href="https://www.nature.com/articles/s44183-025-00113-w">Effects of anthropogenic noise on marine mammal abundances informed by mixed methods</a></li>
<li>Any other paper of your liking</li>
</ul>
</section>
<section id="synthetic-data" class="level2">
<h2 class="anchored" data-anchor-id="synthetic-data">Synthetic data</h2>
<ul>
<li>Maybe you are in the midst of collecting data for your project. You don’t yet have the raw data, but you have a sense of what they will look like (number of columns, number of observations…). I can help you simulate the data<a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a> and you can build a script that helps you get your data into an analysis-ready format.</li>
</ul>
</section>
<section id="other-data-sources" class="level2">
<h2 class="anchored" data-anchor-id="other-data-sources">Other data sources:</h2>
<ul>
<li>Animal tracking data from <a href="https://datarepository.movebank.org/home">MoveBank</a></li>
<li>Vessel tracking data from <a href="https://globalfishingwatch.org/data-download/">Global Fishing Watch</a></li>
</ul>
</section>
<section id="none-of-these-are-working-for-you" class="level2">
<h2 class="anchored" data-anchor-id="none-of-these-are-working-for-you">None of these are working for you?</h2>
<p>Come to office hours and we can discuss ideas.</p>
</section>
</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>or any of their advance cousins like <code>filter_at()</code><a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>If you are using this assignment as part of your own research and you have a legitimate reason to not use a <code>tidy</code> data format, that is ok. Just make sure you include a justification in your code documentation and README files<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p>The data may not exported as <code>.csv</code> but I can help work around that<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn4"><p>The data may not exported as <code>.csv</code> but I can help work around that<a href="#fnref4" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn5"><p>or ask chat GPT for it<a href="#fnref5" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div></main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>